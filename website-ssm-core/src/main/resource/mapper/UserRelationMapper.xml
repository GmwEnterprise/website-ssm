<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.cqut.chat.mapper.UserRelationMapper">

  <resultMap id="relationMap" type="cn.edu.cqut.chat.entity.UserRelation">
    <id property="id" column="id"/>
    <result property="createTime" column="create_time"/>
    <result property="lastModifiedTime" column="last_modified_time"/>
    <result property="remark" column="remark"/>
    <result property="relationType" column="relation_type"
            typeHandler="cn.edu.cqut.chat.common.typehandler.RelationTypeHandler"/>
    <association property="userA" column="user_a"
                 select="cn.edu.cqut.chat.mapper.UserMapper.queryById"/>
    <association property="userB" column="user_b"
                 select="cn.edu.cqut.chat.mapper.UserMapper.queryById"/>
  </resultMap>

  <select id="queryById" resultMap="relationMap">
    select *
    from t_user_relation
    where id = #{id}
  </select>

  <select id="queryAll" resultMap="relationMap">
    select * from t_user_relation a
    <where>
      <if test="userA != null and userA.id != null">
        and user_a = #{userA.id}
      </if>
      <if test="userB != null and userB.id != null">
        and user_b = #{userB.id}
      </if>
      <if test="relationType != null">
        and relation_type = #{relationType.index}
      </if>
    </where>
  </select>

  <insert id="insert" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
    insert into t_user_relation (create_time,
                                 last_modified_time,
                                 remark,
                                 user_a,
                                 user_b,
                                 relation_type)
    values (#{createTime},
            #{lastModifiedTime},
            #{remark},
            #{userA.id},
            #{userB.id},
            #{relationType, typeHandler = cn.edu.cqut.chat.common.typehandler.RelationTypeHandler})
  </insert>

  <update id="update">
    update t_user_relation
    set create_time        = #{createTime},
        last_modified_time = #{lastModifiedTime},
        remark             = #{remark},
        user_a             = #{userA.id},
        user_b             = #{userB.id},
        relation_type      = #{relationType, typeHandler = cn.edu.cqut.chat.common.typehandler.RelationTypeHandler}
    where id = #{id}
  </update>

  <delete id="delete">
    delete
    from t_user
    where id = #{id}
  </delete>
</mapper>